<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Портал подтверждения подписи — Podshoota-Chodak ITB</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --primary: #1a4e8a;
      --bg: #eef3f9;
      --text: #2c3e50;
      --ok: #1f7a1f;
      --muted: #6b7280;
    }
    html,body{margin:0;padding:0;background:var(--bg);font-family:"Times New Roman",serif;color:var(--text)}
    .wrap{max-width:820px;margin:40px auto;padding:0 16px}
    .card{background:#fff;border-radius:16px;box-shadow:0 8px 28px rgba(0,0,0,.15);overflow:hidden}
    .govbar{background:var(--primary);color:#fff;padding:20px;text-align:center;border-bottom:6px solid #12365d}
    .govbar h1{margin:0;font-size:22px;letter-spacing:.5px}
    .content{padding:24px 22px}
    h2{margin:8px 0 16px 0;font-size:22px}
    .row{display:flex;gap:16px;flex-wrap:wrap}
    .col{flex:1 1 280px}
    .field{display:block;width:100%;padding:12px 14px;border:1px solid #cbd5e1;border-radius:10px;font-size:16px;background:#fff}
    .btn{display:inline-block;padding:12px 16px;border-radius:10px;background:var(--primary);color:#fff;text-decoration:none;border:none;cursor:pointer;font-weight:700}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .note{font-size:14px;color:var(--muted)}
    .status{margin:12px 0;padding:12px;border-radius:10px;background:#e8f6ea;border:1px solid #c8ebce;color:var(--ok);font-weight:700}
    .error{background:#fde8ea;border:1px solid #f6c5cc;color:#8c1c2b}
    #qrcode{display:flex;justify-content:center;align-items:center;min-height:220px;margin-top:8px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;word-break:break-all;background:#f3f4f6;border:1px solid #e5e7eb;border-radius:10px;padding:12px}
    .footer{padding:14px 18px;border-top:1px solid #e5e7eb;text-align:center;font-size:14px;color:#4b5563}
    .seal{margin:8px auto 0 auto;display:block;width:84px;height:84px;border-radius:50%;border:3px solid var(--primary);position:relative}
    .seal::after{content:"ITB";position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-weight:900;color:var(--primary)}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="govbar">
        <h1>Podshoota-Chodak ITB · Портал подтверждения подписи</h1>
      </div>

      <div class="content">
        <!-- Блок загрузки / генерации -->
        <div id="uploadBlock">
          <h2>Имитация подписания документа (статическая версия)</h2>
          <div class="row">
            <div class="col">
              <input id="fileInput" type="file" class="field" />
              <div class="note">Файл не отправляется на сервер. Используем имя файла для генерации данных подписи.</div>
            </div>
            <div class="col">
              <input id="dateInput" type="date" class="field" />
              <div class="note">Если оставить пустым — возьмём сегодняшнюю дату.</div>
            </div>
          </div>
          <div class="actions">
            <button id="genBtn" class="btn">Сгенерировать QR-код подписи</button>
            <a id="downloadQR" class="btn" href="#" download="signature_qr.png" style="display:none">Скачать QR</a>
            <button id="copyLink" class="btn" style="display:none">Скопировать ссылку</button>
          </div>
          <div id="genStatus" class="status" style="display:none"></div>
          <div id="qrcode"></div>
          <div id="generatedInfo" style="display:none;margin-top:8px">
            <p><b>Ссылка проверки:</b> <a id="verifyLink" target="_blank" rel="noopener"></a></p>
            <p class="note">Совет: распечатайте QR и прикрепите к бумажной копии.</p>
          </div>
        </div>

        <!-- Блок результата при открытии по ссылке/QR -->
        <div id="verifyBlock" style="display:none">
          <div class="seal" aria-hidden="true"></div>
          <h2>✅ Документ подписан (внутреннее подтверждение)</h2>
          <p><b>Документ:</b> <span id="vFile"></span></p>
          <p><b>Подписал:</b> <span id="vSigner"></span></p>
          <p><b>Дата подписи:</b> <span id="vDate"></span></p>
          <p><b>Хэш (SHA-256):</b></p>
          <div id="vHash" class="mono"></div>
          <div class="status">Подтверждено: документ признан действительным в пределах организации.</div>
        </div>

        <!-- Сообщения об ошибках -->
        <div id="errBlock" class="status error" style="display:none"></div>
      </div>

      <div class="footer">
        Подписант: <b>Podshoota-Chodak ITB, bosh yuristkonsult</b>
      </div>
    </div>
  </div>

  <!-- QRCodeJS (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

  <script>
    // === Конфигурация: ОБЯЗАТЕЛЬНО замените BASE_URL на свой адрес GitHub Pages ===
    // Пример: "https://username.github.io/reponame/index.html"
    const BASE_URL = "https://username.github.io/reponame/index.html"; // TODO: ЗАМЕНИТЕ ЭТО

    const SIGNER = "Podshoota-Chodak ITB, bosh yuristkonsult";

    // Утилиты
    const $ = (id) => document.getElementById(id);
    const today = () => {
      const d = new Date();
      return d.getFullYear() + "-" + String(d.getMonth()+1).padStart(2,"0") + "-" + String(d.getDate()).padStart(2,"0");
    };
    const baseUrl = () => {
      // Если загружено по HTTPS — используем текущий URL; если file:// — используем BASE_URL
      if (location.protocol === "http:" || location.protocol === "https:") {
        // Если страница уже на вашем GitHub Pages и вы не переименовывали файл:
        // убедимся, что есть index.html в конце
        let u = location.origin + location.pathname;
        if (!u.endsWith(".html")) {
          if (!u.endsWith("/")) u += "/";
          u += "index.html";
        }
        return u;
      }
      return BASE_URL; // для локального открытия файла
    };

    // SHA-256: сначала пробуем WebCrypto, если недоступно — JS-фолбэк
    async function sha256(message) {
      if (window.crypto && crypto.subtle && location.protocol.startsWith("http")) {
        const msgBuffer = new TextEncoder().encode(message);
        const hashBuffer = await crypto.subtle.digest("SHA-256", msgBuffer);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        return hashArray.map(b => b.toString(16).padStart(2, "0")).join("");
      }
      // Фолбэк: компактная реализация SHA-256 (JS)
      return sha256Fallback(message);
    }

    // --- Мини-реализация SHA-256 (фолбэк) ---
    function sha256Fallback(ascii) {
      function rightRotate(value, amount) { return (value>>>amount) | (value<<(32-amount)); }
      var mathPow = Math.pow; var maxWord = mathPow(2, 32);
      var lengthProperty = 'length'; var i, j; var result = '';

      var words = [], asciiBitLength = ascii[lengthProperty] * 8;

      var hash = sha256Fallback.h = sha256Fallback.h || [];
      var k = sha256Fallback.k = sha256Fallback.k || [];
      var primeCounter = k[lengthProperty];
      if (!primeCounter) {
        var isPrime = {}; var candidate = 2;
        while (k[lengthProperty] < 64) {
          var isP = !isPrime[candidate];
          if (isP) {
            for (i = 0; i < 313; i += candidate) isPrime[i] = candidate;
            hash[k[lengthProperty]] = (mathPow(candidate, .5)*maxWord)|0;
            k[k[lengthProperty]] = (mathPow(candidate, 1/3)*maxWord)|0;
          }
          candidate++;
        }
      }

      ascii += '\x80';
      while (ascii[lengthProperty] % 64 - 56) ascii += '\x00';
      for (i = 0; i < ascii[lengthProperty]; i++) {
        j = ascii.charCodeAt(i);
        if (j>>8) return; // ASCII only
        words[i>>2] |= j << ((3 - i)%4)*8;
      }
      words[words[lengthProperty]] = ((asciiBitLength/maxWord)|0);
      words[words[lengthProperty]] = (asciiBitLength);

      var w = []; var a,b,c,d,e,f,g,h; var temp;
      for (j = 0; j < words[lengthProperty]; ) {
        a = hash[0]; b = hash[1]; c = hash[2]; d = hash[3];
        e = hash[4]; f = hash[5]; g = hash[6]; h = hash[7];
        for (i = 0; i < 64; i++) {
          w[i] = i < 16 ? words[j + i] :
            (w[i-2]>>>17 ^ w[i-2]<<15 ^ w[i-2]>>>19 ^ w[i-2]<<13 ^ w[i-2]>>>10) +
            w[i-7] +
            (w[i-15]>>>7 ^ w[i-15]<<25 ^ w[i-15]>>>18 ^ w[i-15]<<14 ^ w[i-15]>>>3) +
            w[i-16] | 0;

          temp = h +
            (e>>>6 ^ e<<26 ^ e>>>11 ^ e<<21 ^ e>>>25 ^ e<<7) +
            ((e & f) ^ (~e & g)) +
            k[i] + w[i] | 0;

          h = g; g = f; f = e;
          e = d + temp | 0;
          d = c; c = b; b = a;
          a = temp +
            (a>>>2 ^ a<<30 ^ a>>>13 ^ a<<19 ^ a>>>22 ^ a<<10) +
            ((a & b) ^ (a & c) ^ (b & c)) | 0;
        }
        hash[0] = hash[0] + a | 0;
        hash[1] = hash[1] + b | 0;
        hash[2] = hash[2] + c | 0;
        hash[3] = hash[3] + d | 0;
        hash[4] = hash[4] + e | 0;
        hash[5] = hash[5] + f | 0;
        hash[6] = hash[6] + g | 0;
        hash[7] = hash[7] + h | 0;
        j += 16;
      }
      for (i = 0; i < 8; i++) {
        for (j = 3; j + 1; j--) {
          var b = (hash[i] >> (j * 8)) & 255;
          result += ((b < 16) ? 0 : '') + b.toString(16);
        }
      }
      return result;
    }

    // QR: создаём и подготавливаем кнопки "Скачать" и "Копировать ссылку"
    function renderQR(url) {
      const box = $("qrcode");
      box.innerHTML = "";
      new QRCode(box, { text: url, width: 220, height: 220, correctLevel: QRCode.CorrectLevel.M });
      // Подготовим кнопку скачивания
      setTimeout(() => {
        const img = box.querySelector("img");
        const canvas = box.querySelector("canvas");
        let dataURL = null;
        if (img && img.src) dataURL = img.src;
        if (!dataURL && canvas) dataURL = canvas.toDataURL("image/png");
        if (dataURL) {
          $("downloadQR").href = dataURL;
          $("downloadQR").style.display = "inline-block";
        }
        $("copyLink").style.display = "inline-block";
      }, 150);
    }

    // Генерация подписи (на статике)
    async function generate() {
      const fileEl = $("fileInput");
      if (!fileEl.files || !fileEl.files.length) {
        showErr("Загрузите файл документа.");
        return;
      }
      clearErr();

      const fileName = fileEl.files[0].name;
      const date = $("dateInput").value || today();

      // Хэш формируем из «имя файла + дата + подписант»
      const hash = await sha256(fileName + "|" + date + "|" + SIGNER);

      // Формируем ссылку проверки (все данные в query string)
      const url = baseUrl()
        + "?file=" + encodeURIComponent(fileName)
        + "&date=" + encodeURIComponent(date)
        + "&signer=" + encodeURIComponent(SIGNER)
        + "&hash=" + encodeURIComponent(hash);

      $("verifyLink").href = url;
      $("verifyLink").textContent = url;
      $("generatedInfo").style.display = "block";

      renderQR(url);
      $("genStatus").className = "status";
      $("genStatus").style.display = "block";
      $("genStatus").textContent = "✅ Подпись сгенерирована. QR-код готов.";
      $("copyLink").onclick = () => {
        navigator.clipboard.writeText(url).then(()=> {
          $("genStatus").textContent = "✅ Ссылка скопирована в буфер обмена.";
        });
      };
    }

    // Показ результата при открытии по ссылке (скан QR)
    function showVerificationFromURL() {
      const p = new URLSearchParams(location.search);
      if (!p.has("file")) return false;

      const file = p.get("file") || "(без названия)";
      const date = p.get("date") || "(не указана)";
      const signer = p.get("signer") || SIGNER;
      const hash = p.get("hash") || "";

      $("uploadBlock").style.display = "none";
      $("verifyBlock").style.display = "block";
      $("vFile").textContent = file;
      $("vDate").textContent = date;
      $("vSigner").textContent = signer;
      $("vHash").textContent = hash || "—";

      return true;
    }

    function showErr(msg){
      $("errBlock").style.display="block";
      $("errBlock").textContent = msg;
    }
    function clearErr(){
      $("errBlock").style.display="none";
      $("errBlock").textContent = "";
    }

    // Инициализация
    document.addEventListener("DOMContentLoaded", () => {
      // Если страница открыта по QR (есть параметры) — показываем верификацию
      if (!showVerificationFromURL()) {
        // иначе — режим генерации
        $("genBtn").addEventListener("click", generate);
      }
    });
  </script>
</body>
</html>
